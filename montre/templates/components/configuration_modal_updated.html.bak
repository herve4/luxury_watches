{% load static %}
<div class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" 
     id="config-modal-container">
    
    <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-3xl max-w-7xl w-full max-h-[95vh] overflow-y-auto shadow-2xl border border-slate-700/50">
        
        <!-- En-tête amélioré -->
        <div class="sticky top-0 z-20 bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900/95 backdrop-blur-xl border-b border-slate-600/50 p-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h3 class="font-playfair text-3xl font-bold text-white mb-2 drop-shadow-lg">{{ product.name }}</h3>
                    <p class="text-amber-300 font-light text-lg flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Découvrez les détails de cette pièce exclusive
                    </p>
                </div>
                <button id="close-modal" class="text-slate-400 hover:text-white transition-all duration-300 p-3 hover:bg-slate-700/50 rounded-xl group border border-slate-600/50 hover:border-slate-500">
                    <svg class="w-6 h-6 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            
            <!-- Navigation améliorée -->
            <div class="mt-6">
                <nav class="flex space-x-1 bg-slate-800/50 rounded-2xl p-1 backdrop-blur-sm border border-slate-700/30">
                    <button data-tab="details" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold text-sm transition-all duration-300 group flex items-center justify-center bg-amber-500 text-white shadow-lg">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Détails
                    </button>
                    <button data-tab="specs" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold text-sm transition-all duration-300 group flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-700/50">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Caractéristiques
                    </button>
                    <button data-tab="reviews" class="tab-button flex-1 py-3 px-6 rounded-xl font-semibold text-sm transition-all duration-300 group flex items-center justify-center text-slate-300 hover:text-white hover:bg-slate-700/50">
                        <svg class="w-4 h-4 mr-2 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/>
                        </svg>
                        Avis ({{ product.reviews.count }})
                    </button>
                </nav>
            </div>
        </div>
        
        <!-- Contenu principal amélioré -->
        <div class="p-8">
            <div class="grid xl:grid-cols-2 gap-12">
                
                <!-- Colonne gauche : Visualisation produit améliorée -->
                <div class="space-y-8">
                    <!-- Zone d'affichage principale premium -->
                    <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-3xl p-8 flex items-center justify-center min-h-[550px] relative overflow-hidden group border border-slate-600/30 shadow-2xl" id="image-container">
                        
                        <!-- Effet de brillance premium -->
                        <div class="absolute inset-0 opacity-0 transition-opacity duration-700" id="hover-effect"></div>
                        
                        <!-- Image de la montre avec effets premium -->
                        <div class="relative z-10 transform transition-all duration-700 ease-out" id="image-wrapper">
                            {% if product.images.first %}
                            <img id="watch-image" 
                                 src="{{ product.images.first.image.url }}" 
                                 alt="{{ product.name }}"
                                 class="max-w-full max-h-[450px] object-contain transition-all duration-500 transform-gpu drop-shadow-2xl">
                            {% else %}
                            <div class="max-w-full max-h-[450px] w-full h-full bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl flex items-center justify-center border border-slate-600/50">
                                <div class="text-center">
                                    <i class="fas fa-clock text-8xl text-amber-500/40 mb-4"></i>
                                    <p class="text-slate-400 font-light">Image non disponible</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Indicateur de chargement premium -->
                            <div id="loading-indicator" class="absolute inset-0 hidden items-center justify-center bg-slate-900/80 backdrop-blur-sm rounded-3xl">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-amber-500 border-t-transparent"></div>
                                    <span class="text-amber-300 text-lg font-light">Chargement de l'image...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Badge prix premium -->
                        <div class="absolute top-6 right-6 bg-gradient-to-r from-amber-500 to-amber-600 text-black px-6 py-3 rounded-2xl font-bold text-xl shadow-2xl transform transition-all duration-300 hover:scale-105 border-2 border-amber-400/50" id="price-badge">
                            <span id="price-display">{{ product.price|floatformat:0 }} FCFA</span>
                        </div>
                        
                        <!-- Contrôles de navigation améliorés -->
                        {% if product.images.all|length > 1 %}
                        <button id="prev-image" class="absolute left-6 top-1/2 -translate-y-1/2 bg-slate-900/80 text-white p-4 rounded-2xl hover:bg-slate-800 transition-all duration-300 transform hover:scale-110 opacity-0 group-hover:opacity-100 backdrop-blur-sm border border-slate-600/50 shadow-lg">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button id="next-image" class="absolute right-6 top-1/2 -translate-y-1/2 bg-slate-900/80 text-white p-4 rounded-2xl hover:bg-slate-800 transition-all duration-300 transform hover:scale-110 opacity-0 group-hover:opacity-100 backdrop-blur-sm border border-slate-600/50 shadow-lg">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Galerie miniatures premium améliorée -->
                    {% if product.images.all|length > 1 %}
                    <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-slate-600/30 shadow-xl">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-white font-bold text-lg flex items-center">
                                <svg class="w-6 h-6 mr-3 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                                </svg>
                                Galerie d'images
                            </h4>
                            <span class="text-sm text-slate-400">{{ product.images.all|length }} photos</span>
                        </div>
                        
                        <div class="relative group">
                            <div class="flex space-x-4 overflow-x-auto pb-4 scrollbar-thin hover:scrollbar-thumb-slate-600 scrollbar-thumb-slate-700 scrollbar-track-transparent scrollbar-thumb-rounded-full">
                                {% for img in product.images.all %}
                                <button 
                                    data-image-url="{{ img.image.url }}" 
                                    data-image-index="{{ forloop.counter0 }}" 
                                    class="thumbnail-button flex-shrink-0 w-24 h-24 rounded-xl overflow-hidden border-3 transition-all duration-300 transform hover:scale-105 group/thumbnail relative shadow-lg hover:shadow-xl hover:shadow-amber-500/20"
                                    :class="{ 'border-amber-500 scale-105 shadow-amber-500/30': currentThumbnailIndex === {{ forloop.counter0 }}, 'border-transparent hover:border-amber-400/50': currentThumbnailIndex !== {{ forloop.counter0 }} }"
                                    @click="changeMainImage('{{ img.image.url }}', {{ forloop.counter0 }})"
                                >
                                    <div class="relative w-full h-full">
                                        <img 
                                            src="{{ img.image.url }}" 
                                            alt="{{ img.alt_text|default:product.name }}"
                                            class="w-full h-full object-cover transition-transform duration-500 group-hover/thumbnail:scale-110"
                                            loading="lazy"
                                        >
                                        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/30 opacity-0 group-hover/thumbnail:opacity-100 transition-opacity duration-300"></div>
                                    </div>
                                    <div 
                                        class="absolute inset-0 border-2 border-transparent rounded-lg transition-all duration-300"
                                        :class="{ 'border-amber-400 scale-95': currentThumbnailIndex === {{ forloop.counter0 }} }"
                                    ></div>
                                </button>
                                {% endfor %}
                            </div>
                            
                            <!-- Boutons de navigation de la galerie -->
                            <button class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-2 bg-slate-900/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform hover:scale-110 shadow-lg z-10 border border-slate-600/50" 
                                    @click.prevent="scrollThumbnails('left')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <button class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-2 bg-slate-900/80 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-all duration-300 transform hover:scale-110 shadow-lg z-10 border border-slate-600/50"
                                    @click.prevent="scrollThumbnails('right')">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Colonne droite : Détails et commande améliorés -->
                <div class="space-y-8">
                    <!-- En-tête produit premium -->
                    <div class="text-center xl:text-left bg-slate-800/40 rounded-3xl p-8 border border-slate-600/30 backdrop-blur-sm">
                        <h1 class="font-playfair text-5xl font-bold text-white mb-6 leading-tight drop-shadow-lg">{{ product.name }}</h1>
                        
                        <!-- Prix bien visible -->
                        <div class="flex items-center justify-center xl:justify-start space-x-6 mb-6">
                            <div class="text-4xl font-bold text-amber-500 bg-amber-500/10 px-6 py-3 rounded-2xl border border-amber-500/30" id="total-price-display">
                                {{ product.price|floatformat:0 }} FCFA
                            </div>
                            <div id="original-price" class="text-xl text-slate-400 line-through bg-slate-700/50 px-4 py-2 rounded-xl hidden">
                                {{ product.price|floatformat:0 }} FCFA
                            </div>
                        </div>
                        
                        <p class="text-slate-200 text-xl leading-relaxed font-light max-w-2xl bg-slate-700/30 rounded-2xl p-6 border border-slate-600/50">
                            {{ product.description|truncatewords:40 }}
                        </p>
                    </div>

                    <!-- Onglets de contenu améliorés -->
                    <div class="space-y-8">
                        <!-- Détails du produit améliorés -->
                        <div id="details-tab" class="tab-content">
                            
                            <div class="prose prose-invert prose-lg max-w-none text-slate-200 leading-relaxed bg-slate-800/40 rounded-2xl p-8 border border-slate-600/30">
                                <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                                    <svg class="w-6 h-6 mr-3 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Description détaillée
                                </h3>
                                {{ product.description|safe|linebreaks }}
                            </div>
                            
                            <!-- Caractéristiques principales améliorées -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                                {% if product.movement_type %}
                                <div class="flex items-center space-x-6 p-6 bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl border border-slate-600/50 hover:border-amber-500/30 transition-all duration-300 group hover:scale-105">
                                    <div class="w-16 h-16 bg-amber-500/20 rounded-2xl flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm text-slate-400 font-medium">Mouvement</div>
                                        <div class="font-bold text-white text-lg">{{ product.movement_type }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if product.water_resistance %}
                                <div class="flex items-center space-x-6 p-6 bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl border border-slate-600/50 hover:border-amber-500/30 transition-all duration-300 group hover:scale-105">
                                    <div class="w-16 h-16 bg-amber-500/20 rounded-2xl flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm text-slate-400 font-medium">Étanchéité</div>
                                        <div class="font-bold text-white text-lg">{{ product.water_resistance }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if product.case_material %}
                                <div class="flex items-center space-x-6 p-6 bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl border border-slate-600/50 hover:border-amber-500/30 transition-all duration-300 group hover:scale-105">
                                    <div class="w-16 h-16 bg-amber-500/20 rounded-2xl flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm text-slate-400 font-medium">Boîtier</div>
                                        <div class="font-bold text-white text-lg">{{ product.case_material }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                
                                {% if product.case_diameter %}
                                <div class="flex items-center space-x-6 p-6 bg-gradient-to-br from-slate-800 to-slate-700 rounded-2xl border border-slate-600/50 hover:border-amber-500/30 transition-all duration-300 group hover:scale-105">
                                    <div class="w-16 h-16 bg-amber-500/20 rounded-2xl flex items-center justify-center group-hover:bg-amber-500/30 transition-colors">
                                        <svg class="w-8 h-8 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="text-sm text-slate-400 font-medium">Diamètre</div>
                                        <div class="font-bold text-white text-lg">{{ product.case_diameter }} mm</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Autres onglets -->
                        <div id="specs-tab" class="tab-content hidden">
                            <!-- Contenu des spécifications -->
                        </div>
                        
                        <div id="reviews-tab" class="tab-content hidden">
                            <!-- Contenu des avis -->
                        </div>
                    </div>

                    <!-- Section commande premium -->
                    <div class="pt-8 border-t border-slate-600/50 mt-8">
                        <!-- Bouton de commande principal amélioré avec HTMX -->
                        <div class="space-y-4">
                            <button id="order-button"
                                    hx-get="{% url 'order_create' product_slug=product.slug %}"
                                    hx-push-url="true"
                                    hx-target="body"
                                    class="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-black font-bold py-5 px-8 rounded-2xl transition-all duration-300 transform hover:scale-[1.02] shadow-2xl shadow-amber-500/30 flex items-center justify-center space-x-4 group border-2 border-amber-400/50">
                                <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
                                </svg>
                                <span class="text-xl">Commander Maintenant</span>
                            </button>
                            
                            <!-- Informations supplémentaires améliorées -->
                            <div class="grid grid-cols-2 gap-4 mt-6">
                                <div class="flex items-center space-x-3 p-4 bg-green-500/10 rounded-xl border border-green-500/20">
                                    <svg class="w-6 h-6 text-green-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                    <div>
                                        <div class="text-green-400 font-semibold">Livraison gratuite</div>
                                        <div class="text-green-300 text-sm">Partout au Sénégal</div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                                    <svg class="w-6 h-6 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                    <div>
                                        <div class="text-blue-400 font-semibold">Garantie 2 ans</div>
                                        <div class="text-blue-300 text-sm">Assistance complète</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
// Initialisation d'Alpine.js
document.addEventListener('alpine:init', () => {
    Alpine.data('gallery', () => ({
        currentThumbnailIndex: 0,
        
        init() {
            // Initialisation après le rendu du composant
            this.$nextTick(() => {
                this.setupEventListeners();
                this.scrollToActiveThumbnail();
            });
        },
        
        // Fonction pour faire défiler les miniatures
        scrollThumbnails(direction) {
            const container = this.$el.querySelector('.scrollbar-thin');
            if (!container) return;
            
            const scrollAmount = 200;
            container.scrollBy({
                left: direction === 'left' ? -scrollAmount : scrollAmount,
                behavior: 'smooth'
            });
        },
        
        // Faire défiler vers la miniature active
        scrollToActiveThumbnail() {
            const activeThumb = this.$el.querySelector(`.thumbnail-button[data-image-index="${this.currentThumbnailIndex}"]`);
            if (activeThumb) {
                activeThumb.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }
        },
        
        // Changer l'image principale
        changeMainImage(url, index) {
            if (this.isLoading || this.currentThumbnailIndex === index) return;
            
            this.isLoading = true;
            this.currentThumbnailIndex = index;
            
            const watchImage = this.$el.querySelector('#watch-image');
            const loadingIndicator = this.$el.querySelector('#loading-indicator');
            
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden');
                loadingIndicator.classList.add('flex');
            }
            
            // Précharger la nouvelle image
            const img = new Image();
            img.onload = () => {
                if (watchImage) watchImage.src = url;
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                }
                this.isLoading = false;
                this.scrollToActiveThumbnail();
            };
            img.onerror = () => {
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                    loadingIndicator.classList.remove('flex');
                }
                this.isLoading = false;
                console.error('Erreur de chargement de l\'image:', url);
            };
            img.src = url;
        },
        
        // Configuration des écouteurs d'événements
        setupEventListeners() {
            // Navigation des images principales
            const prevButton = this.$el.querySelector('#prev-image');
            const nextButton = this.$el.querySelector('#next-image');
            
            if (prevButton) {
                prevButton.addEventListener('click', () => this.prevImage());
            }
            if (nextButton) {
                nextButton.addEventListener('click', () => this.nextImage());
            }
            
            // Gestionnaire d'événements pour les miniatures
            const galleryContainer = this.$el.querySelector('.scrollbar-thin');
            if (galleryContainer) {
                galleryContainer.addEventListener('click', (e) => {
                    const thumbnail = e.target.closest('.thumbnail-button');
                    if (thumbnail) {
                        e.preventDefault();
                        const imageUrl = thumbnail.dataset.imageUrl;
                        const imageIndex = parseInt(thumbnail.dataset.imageIndex);
                        if (imageUrl && !isNaN(imageIndex)) {
                            this.changeMainImage(imageUrl, imageIndex);
                        }
                    }
                });
            }
        },
        
        // Image suivante
        nextImage() {
            if (!this.productImages || this.productImages.length <= 1) return;
            const nextIndex = (this.currentThumbnailIndex + 1) % this.productImages.length;
            this.changeMainImage(this.productImages[nextIndex], nextIndex);
        },
        
        // Image précédente
        prevImage() {
            if (!this.productImages || this.productImages.length <= 1) return;
            const prevIndex = (this.currentThumbnailIndex - 1 + this.productImages.length) % this.productImages.length;
            this.changeMainImage(this.productImages[prevIndex], prevIndex);
        },
        
        // Données du composant
        productImages: [
            {% for img in product.images.all %}
                '{{ img.image.url }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        
        // Autres états
        isLoading: false,
        isProcessing: false,
        activeTab: 'details',
        selectedOptions: {},
        totalPrice: {{ product.price }},
        basePrice: {{ product.price }}
    }));
});

// Initialisation des fonctions globales
function initializeModal() {
    document.body.style.overflow = 'hidden';
    updatePriceDisplay();
}

// Fonction pour faire défiler les miniatures horizontalement
function scrollThumbnails(direction) {
    const container = document.querySelector('.scrollbar-thin');
    if (!container) return;
    
    const scrollAmount = 200; // Montant de défilement en pixels
    container.scrollBy({
        left: direction === 'left' ? -scrollAmount : scrollAmount,
        behavior: 'smooth'
    });
}

function setupEventListeners() {
    // Fermeture du modal
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    
    // Navigation des onglets
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
            switchTab(this.dataset.tab);
        });
    });
    
    // Navigation des images principales
    const prevButton = document.getElementById('prev-image');
    const nextButton = document.getElementById('next-image');
    
    if (prevButton) prevButton.addEventListener('click', prevImage);
    if (nextButton) nextButton.addEventListener('click', nextImage);
    
    // Gestionnaire d'événements délégué pour les miniatures
    const galleryContainer = document.querySelector('.scrollbar-thin')?.parentElement;
    if (galleryContainer) {
        galleryContainer.addEventListener('click', function(e) {
            const thumbnail = e.target.closest('.thumbnail-button');
            if (thumbnail) {
                e.preventDefault();
                const imageUrl = thumbnail.dataset.imageUrl;
                const imageIndex = parseInt(thumbnail.dataset.imageIndex);
                if (imageUrl && !isNaN(imageIndex)) {
                    changeMainImage(imageUrl, imageIndex);
                    
                    // Faire défiler la miniature au centre si elle n'est pas visible
                    thumbnail.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest',
                        inline: 'center'
                    });
                }
            }
        });
    }
    
    // Initialisation de la position de défilement de la galerie
    setTimeout(() => {
        const activeThumb = document.querySelector('.thumbnail-button[data-image-index="0"]');
        if (activeThumb) {
            activeThumb.scrollIntoView({
                block: 'nearest',
                inline: 'center'
            });
        }
    }, 100);
    
    // Effets de hover sur l'image
    const imageContainer = document.getElementById('image-container');
    const hoverEffect = document.getElementById('hover-effect');
    
    if (imageContainer && hoverEffect) {
        imageContainer.addEventListener('mousemove', function(e) {
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            hoverEffect.style.background = `radial-gradient(circle at ${x}px ${y}px, rgba(245,158,11,0.15), transparent 70%)`;
            hoverEffect.style.opacity = '1';
            
            document.getElementById('image-wrapper').classList.add('scale-105');
        });
        
        imageContainer.addEventListener('mouseleave', function() {
            hoverEffect.style.opacity = '0';
            document.getElementById('image-wrapper').classList.remove('scale-105');
        });
    }
}

function preloadImages() {
    currentState.productImages.forEach(src => {
        const img = new Image();
        img.src = src;
    });
}

function switchTab(tabName) {
    currentState.activeTab = tabName;
    
    // Mettre à jour les boutons d'onglets
    document.querySelectorAll('.tab-button').forEach(button => {
        if (button.dataset.tab === tabName) {
            button.classList.add('bg-amber-500', 'text-white', 'shadow-lg');
            button.classList.remove('text-slate-300', 'hover:bg-slate-700/50');
        } else {
            button.classList.remove('bg-amber-500', 'text-white', 'shadow-lg');
            button.classList.add('text-slate-300', 'hover:bg-slate-700/50');
        }
    });
    
    // Afficher le contenu de l'onglet
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    document.getElementById(tabName + '-tab').classList.remove('hidden');
}

function changeMainImage(url, index) {
    // Ne rien faire si l'image est déjà en cours de chargement ou si c'est la même image
    if (currentState.isLoading || currentState.currentImage === url) return;

    currentState.isLoading = true;
    currentState.currentThumbnailIndex = index;
    
    const loadingIndicator = document.getElementById('loading-indicator');
    const watchImage = document.getElementById('watch-image');
    const imageWrapper = document.getElementById('image-wrapper');
    
    // Afficher l'indicateur de chargement
    loadingIndicator.classList.remove('hidden');
    loadingIndicator.classList.add('flex');
    
    // Ajouter une classe de transition pour le fondu
    watchImage.classList.add('opacity-0', 'transition-opacity', 'duration-300');
    
    // Précharger la nouvelle image
    const img = new Image();
    img.onload = function() {
        // Une fois l'image chargée, mettre à jour la source
        watchImage.src = url;
        currentState.currentImage = url;
        
        // Attendre que l'image soit mise à jour avant de la faire réapparaître
        setTimeout(() => {
            watchImage.classList.remove('opacity-0');
            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
            currentState.isLoading = false;
            updateThumbnailSelection();
            
            // Ajouter un effet de zoom subtil
            imageWrapper.classList.add('scale-105');
            setTimeout(() => {
                imageWrapper.classList.remove('scale-105');
            }, 200);
        }, 50);
    };
    
    img.onerror = function() {
        // En cas d'erreur, réafficher l'image précédente
        watchImage.classList.remove('opacity-0');
        loadingIndicator.classList.add('hidden');
        loadingIndicator.classList.remove('flex');
        currentState.isLoading = false;
        console.error('Erreur lors du chargement de l\'image:', url);
    };
    
    // Démarrer le chargement de l'image
    img.src = url;
}

function nextImage() {
    if (currentState.productImages.length <= 1) return;
    
    currentState.currentThumbnailIndex = (currentState.currentThumbnailIndex + 1) % currentState.productImages.length;
    changeMainImage(currentState.productImages[currentState.currentThumbnailIndex], currentState.currentThumbnailIndex);
}

function prevImage() {
    if (currentState.productImages.length <= 1) return;
    
    currentState.currentThumbnailIndex = (currentState.currentThumbnailIndex - 1 + currentState.productImages.length) % currentState.productImages.length;
    changeMainImage(currentState.productImages[currentState.currentThumbnailIndex], currentState.currentThumbnailIndex);
}

function updateThumbnailSelection() {
    document.querySelectorAll('.thumbnail-button').forEach((button, index) => {
        if (index === currentState.currentThumbnailIndex) {
            button.classList.add('border-amber-500', 'shadow-amber-500/30', 'scale-105');
            button.classList.remove('border-slate-600', 'hover:border-amber-400');
        } else {
            button.classList.remove('border-amber-500', 'shadow-amber-500/30', 'scale-105');
            button.classList.add('border-slate-600', 'hover:border-amber-400');
        }
    });
}

function formatPrice(price) {
    if (isNaN(price)) return '0 FCFA';
    return new Intl.NumberFormat('fr-FR').format(parseInt(price)) + ' FCFA';
}

function updatePriceDisplay() {
    document.getElementById('price-display').textContent = formatPrice(currentState.totalPrice);
    document.getElementById('total-price-display').textContent = formatPrice(currentState.totalPrice);
    
    const originalPriceElement = document.getElementById('original-price');
    if (currentState.totalPrice > currentState.basePrice) {
        originalPriceElement.textContent = formatPrice(currentState.basePrice);
        originalPriceElement.classList.remove('hidden');
    } else {
        originalPriceElement.classList.add('hidden');
    }
}

// La fonction prepareOrder n'est plus nécessaire car nous utilisons HTMX
// pour la redirection via les attributs du bouton

function showSuccessNotification() {
    const toast = document.createElement('div');
    toast.className = 'fixed top-6 right-6 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] transform translate-x-32 transition-all duration-500 backdrop-blur-sm border border-green-400/30';
    toast.innerHTML = `
{{ ... }}
            <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <div>
                <div class="font-semibold">Configuration enregistrée!</div>
                <div class="text-green-100 text-sm">Redirection vers la page de commande...</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.remove('translate-x-32');
        toast.classList.add('translate-x-0');
    }, 100);
    
    setTimeout(() => {
        toast.classList.remove('translate-x-0');
        toast.classList.add('translate-x-32');
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 500);
    }, 3000);
}

function closeModal() {
    document.body.style.overflow = 'auto';
    document.getElementById('config-modal-container').remove();
}
</script>

<!-- Styles supplémentaires -->
<style>
.scrollbar-thin::-webkit-scrollbar {
    height: 8px;
    width: 8px;
}

.scrollbar-thin::-webkit-scrollbar-track {
    background: #1e293b;
    border-radius: 10px;
}

.scrollbar-thin::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-radius: 10px;
    border: 2px solid #1e293b;
}

.scrollbar-thin::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
}
</style>